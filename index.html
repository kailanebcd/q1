<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dynamic FIRE Simulator ‚Äî WebWorker + Career Shocks</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{ --bg:#071025; --card:#0f1726; --muted:#9aa4b2; --accent:#22c55e; --accent2:#3b82f6; }
html,body{ height:100%; margin:0; background:linear-gradient(180deg,var(--bg),#02101a); color:#e6eef6; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; }
.container-app{ max-width:1200px; margin:20px auto; padding:16px; }
.card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--card)); border:none; color:inherit; border-radius:10px; }
.form-label{ color:var(--muted); font-weight:600; }
.small-muted{ color:var(--muted); font-size:.9rem; }
canvas{ background:transparent; border-radius:8px; }
.stat-card{ text-align:center; padding:12px; border-radius:8px; }
.stat-value{ font-size:1.25rem; font-weight:700; color:#fff; }
.racetrack{ background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; max-height:320px; overflow:auto; }
.racer-row{ display:flex; align-items:center; gap:8px; margin-bottom:7px; }
.racer-name{ width:90px; color:var(--muted); font-size:.9rem; }
.track{ flex:1; height:14px; background:rgba(255,255,255,0.03); border-radius:9px; position:relative; overflow:hidden; }
.racer-bar{ position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:9px; transition: width .08s linear; }
.footer { margin-top:12px; color:var(--muted); text-align:center; }
.btn-small { padding: .25rem .6rem; font-size:0.86rem; }
</style>
</head>
<body>
  <div class="container-app">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 style="margin:0">Dynamic FIRE Risk & Speed Simulator</h2>
        <div class="small-muted">Web Worker Monte Carlo + advanced career shocks ‚Ä¢ client-side only</div>
      </div>
      <div>
        <button id="exportLB" class="btn btn-outline-light btn-small">Export leaderboard</button>
      </div>
    </div>

    <div class="row g-3">
      <!-- Controls -->
      <div class="col-lg-3">
        <div class="card p-3 mb-3">
          <h5 class="mb-2">Simulation</h5>
          <form id="simForm" autocomplete="off">
            <div class="mb-2">
              <label class="form-label" for="years">Horizon (years)</label>
              <input id="years" class="form-control form-control-sm" type="number" min="1" max="100" value="40">
            </div>
            <div class="mb-2">
              <label class="form-label" for="trials">Trials</label>
              <input id="trials" class="form-control form-control-sm" type="number" min="10" max="50000" value="2000">
              <div class="small-muted">Use Web Worker for high counts</div>
            </div>

            <hr style="border-top:1px dashed rgba(255,255,255,0.03)">

            <h6 class="mb-2">Portfolio</h6>
            <div class="mb-2">
              <label class="form-label" for="startPortfolio">Start portfolio ($)</label>
              <input id="startPortfolio" class="form-control form-control-sm" type="number" min="0" value="50000" step="100">
            </div>
            <div class="mb-2">
              <label class="form-label" for="mu">Annual return Œº</label>
              <input id="mu" class="form-control form-control-sm" type="number" step="0.01" value="0.06">
            </div>
            <div class="mb-2">
              <label class="form-label" for="sigma">Annual vol œÉ</label>
              <input id="sigma" class="form-control form-control-sm" type="number" step="0.01" value="0.16">
            </div>

            <hr style="border-top:1px dashed rgba(255,255,255,0.03)">

            <h6 class="mb-2">Career shocks</h6>
            <div class="mb-2">
              <label class="form-label" for="startSalary">Start salary ($/yr)</label>
              <input id="startSalary" class="form-control form-control-sm" type="number" min="0" value="60000" step="1000">
            </div>
            <div class="mb-2">
              <label class="form-label" for="saveRate">Save rate (fraction)</label>
              <input id="saveRate" class="form-control form-control-sm" type="number" step="0.01" min="0" max="1" value="0.2">
            </div>

            <div class="mb-2">
              <label class="form-label" for="raiseProb">Raise chance (per year)</label>
              <input id="raiseProb" class="form-control form-control-sm" type="number" step="0.01" min="0" max="1" value="0.25">
            </div>
            <div class="mb-2">
              <label class="form-label" for="raiseMu">Raise Œº (lognormal)</label>
              <input id="raiseMu" class="form-control form-control-sm" type="number" step="0.01" value="0.03">
            </div>
            <div class="mb-2">
              <label class="form-label" for="raiseSigma">Raise œÉ (lognormal)</label>
              <input id="raiseSigma" class="form-control form-control-sm" type="number" step="0.01" value="0.02">
            </div>

            <div class="mb-2">
              <label class="form-label" for="layoffProb">Layoff prob (per year)</label>
              <input id="layoffProb" class="form-control form-control-sm" type="number" step="0.01" min="0" max="1" value="0.05">
            </div>

            <div class="mb-2">
              <label class="form-label" for="layoffMeanMonths">Mean layoff duration (months)</label>
              <input id="layoffMeanMonths" class="form-control form-control-sm" type="number" step="1" min="1" value="6">
            </div>

            <div class="mb-2">
              <label class="form-label" for="recoveryMin">Recovery fraction min</label>
              <input id="recoveryMin" class="form-control form-control-sm" type="number" step="0.01" min="0" max="1" value="0.7">
            </div>
            <div class="mb-2">
              <label class="form-label" for="recoveryMax">Recovery fraction max</label>
              <input id="recoveryMax" class="form-control form-control-sm" type="number" step="0.01" min="0" max="1" value="1.0">
            </div>

            <hr style="border-top:1px dashed rgba(255,255,255,0.03)">

            <h6 class="mb-2">Retirement</h6>
            <div class="mb-2">
              <label class="form-label" for="targetPortfolio">Target ($)</label>
              <input id="targetPortfolio" class="form-control form-control-sm" type="number" min="0" value="1000000" step="1000">
            </div>
            <div class="mb-2">
              <label class="form-label" for="spendRate">Spending rate (annual fraction)</label>
              <input id="spendRate" class="form-control form-control-sm" type="number" step="0.01" min="0" max="0.3" value="0.04">
            </div>

            <div class="d-grid mt-2">
              <button id="runBtn" class="btn btn-success btn-sm" type="submit">‚ñ∂ Run (worker)</button>
            </div>
          </form>
        </div>

        <div class="card p-3">
          <h6>Leaderboard (local)</h6>
          <div id="leaderboardList" style="max-height:220px; overflow:auto;"></div>
          <div class="d-grid mt-2">
            <button id="clearLB" class="btn btn-outline-danger btn-sm">Clear leaderboard</button>
          </div>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="col-lg-9">
        <div class="row g-3">
          <div class="col-sm-4"><div class="card stat-card p-3"><div class="small-muted">Fastest (years)</div><div id="statFastest" class="stat-value">‚Äî</div></div></div>
          <div class="col-sm-4"><div class="card stat-card p-3"><div class="small-muted">Median (years)</div><div id="statMedian" class="stat-value">‚Äî</div></div></div>
          <div class="col-sm-4"><div class="card stat-card p-3"><div class="small-muted">Success rate</div><div id="statSuccess" class="stat-value">‚Äî</div></div></div>

          <div class="col-12">
            <div class="card p-3">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6 class="small-muted mb-2">Years to FIRE (successful trials)</h6>
                  <canvas id="histFIRE"></canvas>
                </div>
                <div class="col-md-6 mb-3">
                  <h6 class="small-muted mb-2">Final net worth (all trials)</h6>
                  <canvas id="histFinal"></canvas>
                </div>
              </div>

              <div class="row mt-3">
                <div class="col-md-8 mb-3">
                  <h6 class="small-muted mb-2">Sample portfolio paths</h6>
                  <canvas id="pathsChart" style="height:300px"></canvas>
                </div>
                <div class="col-md-4">
                  <h6 class="small-muted mb-2">Speedrun (sample racers)</h6>
                  <div class="racetrack" id="racetrack"></div>
                  <div class="small-muted mt-2"><strong>Target:</strong> <span id="targetValue">‚Äî</span></div>
                  <div class="mt-2">
                    <label class="form-label small-muted">Name</label>
                    <input id="playerName" class="form-control form-control-sm" maxlength="30" placeholder="Your name (optional)">
                    <div class="d-grid mt-2"><button id="submitRun" class="btn btn-primary btn-sm">üèÅ Submit run</button></div>
                  </div>
                </div>
              </div>

              <div class="small-muted mt-3">Worker-based simulation + richer career shocks. Use large trial counts ‚Äî UI stays responsive.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Static app ‚Äî runs fully in-browser. Use export to save leaderboard CSV.</div>
  </div>

<script>
/* ---------------------------
   Worker script as a Blob
   --------------------------- */
const workerCode = `
// Web Worker: Monte Carlo + career shock simulator
self.addEventListener('message', (evt) => {
  const { type } = evt.data;
  if (type === 'start') {
    runMonteCarlo(evt.data.params);
  } else if (type === 'cancel') {
    // simple cancel flag
    self._cancel = true;
  }
});

function mulberry32(a) {
  return function() {
    var t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
// normal via Box-Muller using PRNG
function makeNormal(rng) {
  let cached = null;
  return function() {
    if (cached !== null) { const v = cached; cached = null; return v; }
    let u = 0, v = 0;
    while (u === 0) u = rng();
    while (v === 0) v = rng();
    const mag = Math.sqrt(-2.0 * Math.log(u));
    const z0 = mag * Math.cos(2 * Math.PI * v);
    const z1 = mag * Math.sin(2 * Math.PI * v);
    cached = z1;
    return z0;
  };
}

// draw exponential with mean m (if m <=0, return 0)
function exponentialSample(rng, mean) {
  if (!isFinite(mean) || mean <= 0) return 0;
  const u = rng();
  return -Math.log(1 - u) * mean;
}

// lognormal multiplicative draw: exp(mu + sigma * z) where z ~ N(0,1)
function lognormalSample(normalFn, mu, sigma) {
  return Math.exp(mu + sigma * normalFn());
}

function simulateSingleTrial(params, rng, normalFn) {
  const stepsPerYear = 12;
  const dt = 1/stepsPerYear;
  const nSteps = Math.round(params.years * stepsPerYear);

  let networth = params.startPortfolio;
  let salary = params.startSalary;
  const networthPath = new Array(nSteps + 1);
  networthPath[0] = networth;

  let retired = false;
  let timeToFire = null;

  const raiseProbPerStep = 1 - Math.pow(1 - params.raiseProb, dt);
  const layoffProbPerStep = 1 - Math.pow(1 - params.layoffProb, dt);

  for (let t = 1; t <= nSteps; t++) {
    if (self._cancel) return { cancelled: true };

    // GBM growth
    const z = normalFn();
    const growth = Math.exp((params.mu - 0.5 * params.sigma * params.sigma) * dt + params.sigma * Math.sqrt(dt) * z);
    networth *= growth;

    if (!retired) {
      // raises
      if (rng() < raiseProbPerStep) {
        const mult = lognormalSample(normalFn, params.raiseMu, params.raiseSigma);
        salary *= mult;
      }

      // layoffs
      if (rng() < layoffProbPerStep) {
        // duration drawn from exponential with mean layoffMeanMonths then ceil to int months
        const durMonths = Math.max(1, Math.round(exponentialSample(rng, params.layoffMeanMonths)));
        // simulate durMonths months of zero income by advancing time steps while applying market growth
        for (let d = 0; d < durMonths && t <= nSteps; d++, t++) {
          // growth for this extra step
          const zz = normalFn();
          const g2 = Math.exp((params.mu - 0.5 * params.sigma * params.sigma) * dt + params.sigma * Math.sqrt(dt) * zz);
          networth *= g2;
          networthPath[t] = networth;
        }
        // after layoff, resume at reduced salary drawn uniformly between recoveryMin and recoveryMax
        const recovery = params.recoveryMin + rng() * (params.recoveryMax - params.recoveryMin);
        salary = Math.max(0, salary * recovery);
        // if we've moved beyond nSteps due to inner loop, break
        if (t > nSteps) break;
      }

      // contribution
      const contribution = salary * params.saveRate * dt;
      networth += contribution;
    } else {
      // withdrawals
      const withdraw = networth * params.spendRate * dt;
      networth = Math.max(0, networth - withdraw);
    }

    networthPath[t] = networth;

    if (!retired && params.targetPortfolio != null && networth >= params.targetPortfolio) {
      retired = true;
      timeToFire = t * dt;
    }
  }

  return { timeToFire, finalNetworth: networth, networthPath };
}

async function runMonteCarlo(params) {
  self._cancel = false;
  const trials = params.trials;
  const batch = Math.max(5, Math.floor(trials / 200));
  const results = { fireTimes: [], finals: [], samples: [] };

  // seed base: if undefined use random
  const baseSeed = params.seed != null ? params.seed : Math.floor(Math.random() * 2**31);
  for (let i = 0; i < trials; i += batch) {
    if (self._cancel) break;
    const end = Math.min(trials, i + batch);
    for (let j = i; j < end; j++) {
      const seed = (baseSeed + j) | 0;
      const rng = mulberry32(seed);
      const normalFn = makeNormal(rng);
      const out = simulateSingleTrial(params, rng, normalFn);
      if (out.cancelled) { self.postMessage({ type: 'cancelled' }); return; }
      if (out.timeToFire != null) results.fireTimes.push(out.timeToFire);
      results.finals.push(out.finalNetworth);
      if (results.samples.length < 12) results.samples.push(out);
    }
    // post progress
    self.postMessage({ type: 'progress', completed: end, total: trials, partial: results });
    // small pause to avoid starving UI thread (worker is separate but keep responsive)
    await new Promise(r => setTimeout(r, 1));
  }

  self.postMessage({ type: 'done', results });
}
`;

/* Create the worker from the blob */
const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
const workerURL = URL.createObjectURL(workerBlob);
let simWorker = null;

/* ---------------------------
   Main thread: charts & UI
   --------------------------- */
let chartFire = null, chartFinal = null, chartPaths = null;

function initCharts() {
  const ctxF = document.getElementById('histFIRE').getContext('2d');
  if (chartFire) chartFire.destroy();
  chartFire = new Chart(ctxF, {
    type: 'bar',
    data: { labels: [], datasets: [{ label:'Years to FIRE', data: [], backgroundColor: createGradient(ctxF, '#22c55e', '#065f46') }] },
    options: { plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#cbd5e1'}}, y:{ticks:{color:'#cbd5e1'}} }, animation:{duration:400} }
  });

  const ctxN = document.getElementById('histFinal').getContext('2d');
  if (chartFinal) chartFinal.destroy();
  chartFinal = new Chart(ctxN, {
    type: 'bar',
    data: { labels: [], datasets: [{ label:'Final NW', data: [], backgroundColor: createGradient(ctxN, '#3b82f6', '#1e3a8a') }] },
    options: { plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#cbd5e1'}}, y:{ticks:{color:'#cbd5e1'}} }, animation:{duration:400} }
  });

  const ctxP = document.getElementById('pathsChart').getContext('2d');
  if (chartPaths) chartPaths.destroy();
  chartPaths = new Chart(ctxP, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
      plugins:{legend:{display:false}},
      scales:{ x:{ticks:{color:'#cbd5e1'}}, y:{ticks:{color:'#cbd5e1'}, beginAtZero:true} },
      animation:{duration:200, easing:'linear'}
    }
  });
}

function createGradient(ctx, c1, c2) {
  const g = ctx.createLinearGradient(0,0,ctx.canvas.width,0);
  g.addColorStop(0, c1);
  g.addColorStop(1, c2);
  return g;
}

function histogram(values, bins=25) {
  if (!values || values.length === 0) return { labels:[], counts:[] };
  const min = Math.min(...values);
  const max = Math.max(...values);
  const span = (max - min) || 1;
  const step = span / bins;
  const counts = new Array(bins).fill(0);
  for (const v of values) {
    let idx = Math.floor((v - min) / step);
    if (idx < 0) idx = 0;
    if (idx >= bins) idx = bins - 1;
    counts[idx]++;
  }
  const labels = counts.map((_, i) => (min + i * step).toFixed(1));
  return { labels, counts };
}

/* Racetrack helpers */
function initRacers(n=12) {
  const racetrack = document.getElementById('racetrack');
  racetrack.innerHTML = '';
  const rows = [];
  for (let i = 0; i < n; i++) {
    const r = document.createElement('div'); r.className='racer-row';
    const name = document.createElement('div'); name.className='racer-name'; name.textContent = 'Racer ' + (i+1);
    const track = document.createElement('div'); track.className='track';
    const bar = document.createElement('div'); bar.className='racer-bar';
    track.appendChild(bar);
    r.appendChild(name); r.appendChild(track);
    racetrack.appendChild(r);
    rows.push({ row: r, bar });
  }
  return rows;
}

function animateRacersFromSamples(rows, samples, target) {
  const n = Math.min(rows.length, samples.length);
  rows.forEach(r => r.bar.style.width = '0%');
  const maxSteps = Math.max(...samples.map(s => s.networthPath.length));
  let t = 0;
  function frame() {
    for (let i = 0; i < n; i++) {
      const samp = samples[i];
      const idx = Math.min(samp.networthPath.length - 1, t);
      const val = samp.networthPath[idx];
      const pct = Math.min(100, Math.max(0, (val / target) * 100));
      rows[i].bar.style.width = pct + '%';
    }
    t++;
    if (t <= maxSteps) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

/* Leaderboard (localStorage) */
const LB_KEY = 'fire_speedrun_lb_v2';
function loadLB(){ try { return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); } catch(e){ return []; } }
function saveLB(list){ localStorage.setItem(LB_KEY, JSON.stringify(list)); renderLB(); }
function addLB(entry){ const l = loadLB(); l.push(entry); while(l.length>300) l.shift(); saveLB(l); }
function clearLB(){ localStorage.removeItem(LB_KEY); renderLB(); }
function renderLB(){
  const container = document.getElementById('leaderboardList'); container.innerHTML = '';
  const list = loadLB().slice().reverse();
  if (!list.length) { container.innerHTML = '<div class="small-muted">No entries yet</div>'; return; }
  for (const e of list) {
    const div = document.createElement('div'); div.className = 'd-flex justify-content-between py-1 border-bottom';
    div.innerHTML = '<div><div style="font-weight:600">'+escapeHtml(e.name||'Anonymous')+'</div><div class="small-muted">'+new Date(e.timestamp).toLocaleString()+'</div></div><div class="text-end"><div style="font-weight:700">'+(isFinite(e.fastest)?e.fastest.toFixed(2)+'y':'‚Äî')+'</div><div class="small-muted">median '+(isFinite(e.median)?e.median.toFixed(2)+'y':'‚Äî')+'</div></div>';
    container.appendChild(div);
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* UI wiring */
document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  renderLB();
  const racerRows = initRacers(12);

  const form = document.getElementById('simForm');
  const runBtn = document.getElementById('runBtn');

  form.addEventListener('submit', (ev) => {
    ev.preventDefault();
    if (simWorker) {
      // already running -> cancel
      simWorker.postMessage({ type: 'cancel' });
      runBtn.textContent = 'Cancelling...';
      runBtn.classList.remove('btn-success');
      runBtn.classList.add('btn-warning');
      return;
    }
    // read params
    const params = {
      years: Number(document.getElementById('years').value) || 40,
      trials: Number(document.getElementById('trials').value) || 1000,
      startPortfolio: Number(document.getElementById('startPortfolio').value) || 50000,
      mu: Number(document.getElementById('mu').value) || 0.06,
      sigma: Number(document.getElementById('sigma').value) || 0.16,
      startSalary: Number(document.getElementById('startSalary').value) || 60000,
      saveRate: Number(document.getElementById('saveRate').value) || 0.2,
      raiseProb: Number(document.getElementById('raiseProb').value) || 0.25,
      raiseMu: Number(document.getElementById('raiseMu').value) || 0.03,
      raiseSigma: Number(document.getElementById('raiseSigma').value) || 0.02,
      layoffProb: Number(document.getElementById('layoffProb').value) || 0.05,
      layoffMeanMonths: Number(document.getElementById('layoffMeanMonths').value) || 6,
      recoveryMin: Number(document.getElementById('recoveryMin').value) || 0.7,
      recoveryMax: Number(document.getElementById('recoveryMax').value) || 1.0,
      targetPortfolio: Number(document.getElementById('targetPortfolio').value) || 1000000,
      spendRate: Number(document.getElementById('spendRate').value) || 0.04,
      saveRate: Number(document.getElementById('saveRate').value) || 0.2,
      seed: Math.floor(Math.random()*2**31)
    };

    // map worker param names to those used in worker code
    const workerParams = {
      years: params.years,
      trials: params.trials,
      startPortfolio: params.startPortfolio,
      mu: params.mu,
      sigma: params.sigma,
      startSalary: params.startSalary,
      saveRate: params.saveRate,
      raiseProb: params.raiseProb,
      raiseMu: params.raiseMu,
      raiseSigma: params.raiseSigma,
      layoffProb: params.layoffProb,
      layoffMeanMonths: params.layoffMeanMonths,
      recoveryMin: params.recoveryMin,
      recoveryMax: params.recoveryMax,
      targetPortfolio: params.targetPortfolio,
      spendRate: params.spendRate,
      seed: params.seed
    };

    // UI reset
    document.getElementById('statFastest').textContent = '‚Äî';
    document.getElementById('statMedian').textContent = '‚Äî';
    document.getElementById('statSuccess').textContent = '‚Äî';
    initCharts();
    document.getElementById('targetValue').textContent = formatDollars(workerParams.targetPortfolio);
    const statusEl = document.createElement('div'); statusEl.className = 'small-muted mt-2'; statusEl.textContent = 'Starting...';
    runBtn.parentNode.insertBefore(statusEl, runBtn.nextSibling);

    // create worker and start
    simWorker = new Worker(workerURL);
    runBtn.textContent = 'Running... (click to cancel)';
    runBtn.classList.remove('btn-success'); runBtn.classList.add('btn-danger');
    const rows = racerRows;

    simWorker.onmessage = (ev) => {
      const msg = ev.data;
      if (msg.type === 'progress') {
        const { completed, total, partial } = msg;
        statusEl.textContent = completed + ' / ' + total + ' trials';
        // incremental chart updates
        const fire = partial.fireTimes;
        const finals = partial.finals;
        const fastest = fire.length ? Math.min(...fire) : null;
        const median = fire.length ? fire.slice().sort((a,b)=>a-b)[Math.floor(fire.length/2)] : null;
        const success = (fire.length / Math.max(1, total) * 100);

        document.getElementById('statFastest').textContent = fastest ? fastest.toFixed(2) : '‚Äî';
        document.getElementById('statMedian').textContent = median ? median.toFixed(2) : '‚Äî';
        document.getElementById('statSuccess').textContent = success.toFixed(1) + '%';

        const hF = histogram(fire, 30);
        chartFire.data.labels = hF.labels;
        chartFire.data.datasets[0].data = hF.counts;
        chartFire.update();

        const hN = histogram(finals, 30);
        chartFinal.data.labels = hN.labels;
        chartFinal.data.datasets[0].data = hN.counts;
        chartFinal.update();

        // sample paths update
        if (partial.samples && partial.samples.length) {
          const samp = partial.samples;
          const steps = samp[0].networthPath.length;
          chartPaths.data.labels = new Array(steps).fill(0).map((_,i)=> (i/12).toFixed(1));
          chartPaths.data.datasets = samp.map((s, idx) => ({
            label: 's' + idx,
            data: s.networthPath,
            borderColor: `rgba(255,255,255,${0.15 + idx*0.05})`,
            pointRadius: 0, borderWidth: 1.2, tension: 0.25, fill:false
          }));
          chartPaths.update();
          // animate racers
          animateRacersFromSamples(rows, samp, workerParams.targetPortfolio);
        }

      } else if (msg.type === 'done') {
        statusEl.textContent = 'Complete ‚Äî ' + msg.results.finals.length + ' trials';
        const results = msg.results;
        const fastest = results.fireTimes.length ? Math.min(...results.fireTimes) : null;
        const median = results.fireTimes.length ? results.fireTimes.slice().sort((a,b)=>a-b)[Math.floor(results.fireTimes.length/2)] : null;
        const success = (results.fireTimes.length / Math.max(1, workerParams.trials) * 100);

        document.getElementById('statFastest').textContent = fastest ? fastest.toFixed(2) : '‚Äî';
        document.getElementById('statMedian').textContent = median ? median.toFixed(2) : '‚Äî';
        document.getElementById('statSuccess').textContent = success.toFixed(1) + '%';

        const hF = histogram(results.fireTimes, 40);
        chartFire.data.labels = hF.labels; chartFire.data.datasets[0].data = hF.counts; chartFire.update();
        const hN = histogram(results.finals, 40);
        chartFinal.data.labels = hN.labels; chartFinal.data.datasets[0].data = hN.counts; chartFinal.update();

        // final sample display
        if (results.samples.length) {
          const samp = results.samples;
          const steps = samp[0].networthPath.length;
          chartPaths.data.labels = new Array(steps).fill(0).map((_,i)=> (i/12).toFixed(1));
          chartPaths.data.datasets = samp.map((s, idx) => ({
            label: 's' + idx,
            data: s.networthPath,
            borderColor: `rgba(255,255,255,${0.15 + idx*0.05})`,
            pointRadius: 0, borderWidth: 1.2, tension: 0.25, fill:false
          }));
          chartPaths.update();
          animateRacersFromSamples(rows, samp, workerParams.targetPortfolio);
        }

        // tidy up
        simWorker.terminate(); simWorker = null;
        runBtn.textContent = '‚ñ∂ Run (worker)'; runBtn.classList.remove('btn-danger'); runBtn.classList.add('btn-success');
        if (statusEl && statusEl.parentNode) statusEl.remove();
      } else if (msg.type === 'cancelled') {
        statusEl.textContent = 'Cancelled';
        simWorker.terminate(); simWorker = null;
        runBtn.textContent = '‚ñ∂ Run (worker)'; runBtn.classList.remove('btn-warning'); runBtn.classList.add('btn-success');
        if (statusEl && statusEl.parentNode) statusEl.remove();
      }
    };

    // start it
    simWorker.postMessage({ type: 'start', params: workerParams });
  });

  // submit run to leaderboard
  document.getElementById('submitRun').addEventListener('click', () => {
    const name = (document.getElementById('playerName').value || 'Anonymous').trim().slice(0,30);
    const fastest = parseFloat(document.getElementById('statFastest').textContent) || null;
    const median = parseFloat(document.getElementById('statMedian').textContent) || null;
    if (!fastest && !median) { alert('No successful runs to submit.'); return; }
    addLB({ name, fastest, median, timestamp: new Date().toISOString() });
    alert('Submitted to local leaderboard');
  });

  document.getElementById('clearLB').addEventListener('click', () => { if (confirm('Clear local leaderboard?')) clearLB(); });
  document.getElementById('exportLB').addEventListener('click', () => {
    const list = loadLB(); if (!list.length) { alert('Empty leaderboard'); return; }
    const csv = ['timestamp,name,fastest,median'].concat(list.map(r => [r.timestamp, '"' + (r.name||'').replace(/"/g,'""') + '"', r.fastest ?? '', r.median ?? ''].join(','))).join('\\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='leaderboard.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500);
  });

}); // DOM loaded

/* small helpers */
function formatDollars(x){ if (!isFinite(x)) return '‚Äî'; if (x>=1e9) return '$'+(x/1e9).toFixed(2)+'B'; if (x>=1e6) return '$'+(x/1e6).toFixed(2)+'M'; if (x>=1e3) return '$'+Math.round(x).toLocaleString(); return '$'+Math.round(x); }
function animateRacersFromSamples(rows, samples, target) {
  const n = Math.min(rows.length, samples.length);
  rows.forEach(r => r.bar.style.width = '0%');
  const maxSteps = Math.max(...samples.map(s => s.networthPath.length));
  let t = 0;
  function frame() {
    for (let i=0;i<n;i++){
      const samp = samples[i]; const idx = Math.min(samp.networthPath.length-1, t); const val = samp.networthPath[idx];
      const pct = Math.min(100, Math.max(0, (val / target) * 100));
      rows[i].bar.style.width = pct + '%';
    }
    t++; if (t <= maxSteps) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}
</script>
</body>
</html>
